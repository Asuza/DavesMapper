var TileDeck,artBoard,artMode,imgBoard,mypos,myrot,mywid,myhei,mapWidth,mapHeight,endcaps,corners,endstag,map_kind,imgho=new Image,scaled=!1,swap=!1,inrotate=!1,currentmode=0,gridsize=0,buggedyet=0,maptype=1,stagcount=0,tilecount=0,normalTileCount=0,edgeTileCount=0,detectedrotate=0,tileSetOptions="",imag="",iMenuTarget=null,roomContents=["Empty","Monster(s) and Treasure","Monster(s) and Treasure","Empty, Hidden Treasure","Trap, Treasure","Trap","Monster(s)","Monster(s)","Monster(s)","Monster(s)"],specialContents=["Hindrance","Danger","Advantage","Mystery","Special Creature","Odor","Power"],$appmode=window.navigator.standalone,$mobilemode=/iphone|ipod|ipad|android/gi.test(window.navigator.platform),$issafari=/Safari/i.test(window.navigator.appVersion),ua=window.navigator.userAgent,mainTiles,edgeTiles,cornerTiles,topTiles,tcoTiles,btmTiles,bcoTiles;TileDeck=function(){this.deck=[],this.cursor=0},TileDeck.prototype.shuffle=function(){this.deck.sort(function(){return Math.round(Math.random())-.5})},TileDeck.prototype.draw=function(){var e=this.deck[this.cursor];return this.cursor+=1,this.cursor%this.deck.length===0&&(this.cursor=0,this.shuffle()),e},TileDeck.prototype.stock=function(e){this.deck=e||[],this.cursor=0,this.shuffle()},mainTiles=new TileDeck,edgeTiles=new TileDeck,cornerTiles=new TileDeck,topTiles=new TileDeck,tcoTiles=new TileDeck,btmTiles=new TileDeck,bcoTiles=new TileDeck;var createCookie=function(e,t,n){"use strict";var r,i;n?(r=new Date,r.setTime(r.getTime()+n*24*60*60*1e3),i="; expires="+r.toGMTString()):i="",document.cookie=e+"="+t+i+"; path=/"},readCookie=function(e){"use strict";var t=e+"=",n=document.cookie.split(";"),r,i;for(r=0;r<n.length;r+=1){i=n[r];while(i.charAt(0)===" ")i=i.substring(1,i.length);if(i.indexOf(t)===0)return i.substring(t.length,i.length)}return null},eraseCookie=function(e){"use strict";createCookie(e,"",-1)},appendTab=function(e){"use strict";$("#tiles").append("<img class='tab rot"+e+"' data-rot='"+e+"' data-type='tab' src='../images/tab.png'/>")},appendTile=function(e,t){"use strict";var n;switch(e){case"corner":n=cornerTiles.draw();break;case"edge":n=edgeTiles.draw();break;case"top":n=topTiles.draw();break;case"tco":n=tcoTiles.draw();break;case"btm":n=btmTiles.draw();break;case"bco":n=bcoTiles.draw();break;default:n=mainTiles.draw()}$("#tiles").append("<img draggable='true' class='"+e+" rot"+t+"' data-rot='"+t+"' data-type='"+e+"' data-imgid='"+n.id+"' data-artist='"+n.artist_id+"' src='../tiles/"+n.image+"'/>")},composeMap=function(e,t){"use strict";var n,r,i,s,o,u,a,f;endstag=edgeTiles.deck.length>0&&currentmode===3,endcaps=edgeTiles.deck.length>0&&currentmode===2,corners=cornerTiles.deck.length>0&&currentmode===2,maptype===6?(n=topTiles.deck.length>0&&currentmode===2,i=tcoTiles.deck.length>0&&currentmode===2,r=btmTiles.deck.length>0&&currentmode===2,s=bcoTiles.deck.length>0&&currentmode===2,$("#viewport").removeClass("nm").addClass("sv"),$("#notification").slideUp("fast")):($("#viewport").removeClass("sv").addClass("nm"),currentmode!==2&&currentmode!==3||edgeTiles.deck.length!==0&&cornerTiles.deck.length!==0?$("#notification").slideUp("fast"):($("#notification span").text("The tile sets you selected do not contain the right tile mix for your selected map mode. Falling back to the closest possible map mode."),$("#notification").slideDown("fast")));if(currentmode!==4){o=300*e+2,endcaps&&(o+=300),$("#map, #tiles").width(o+"px"),$("#tiles").empty();if(maptype!==6){if(endcaps){corners&&appendTile("corner",0);for(a=0;a<e-stagcount;a+=1)appendTile("edge",0);corners&&appendTile("corner",1),$("#tiles").append("<br/>")}}else if(n){i&&appendTile("tco",0);for(a=0;a<e-stagcount;a+=1)appendTile("top",0);i&&appendTile("tco",1),$("#tiles").append("<br/>")}for(u=0;u<t;u+=1){f=maptype===6?0:3,(endcaps||endstag&&stagcount===1)&&appendTile("edge",f);for(a=0;a<e-stagcount;a+=1)appendTile("tile",randInt(0,3));(endcaps||endstag&&stagcount===1)&&appendTile("edge",1);if(currentmode===1||currentmode===3)stagcount=1-stagcount;$("#tiles").append("<br/>")}if(maptype!==6){if(endcaps){corners&&appendTile("corner",3);for(a=0;a<e-stagcount;a+=1)appendTile("edge",2);corners&&appendTile("corner",2),$("#tiles").append("<br/>")}}else if(r){s&&appendTile("bco",0);for(a=0;a<e-stagcount;a+=1)appendTile("btm",0);s&&appendTile("bco",1),$("#tiles").append("<br/>")}}else $("#map, #tiles").width("902px"),$("#tiles").empty(),appendTab(0),appendTile("tile",randInt(0,3)),appendTab(2),$("#tiles").append("<br/>"),appendTile("tile",randInt(0,3)),appendTile("tile",randInt(0,3)),appendTile("tile",randInt(0,3)),$("#tiles").append("<br/>"),appendTab(0),appendTile("tile",randInt(0,3)),appendTab(2),$("#tiles").append("<br/>"),appendTab(0),appendTile("tile",randInt(0,3)),appendTab(2),$("#tiles").append("<br/>"),$("#tiles").append("<img class='rot0' data-rot='0' data-type='tab' src='../images/tab_bottom.png'/>");tilecount=$("#tiles img").length},drawMap=function(){"use strict";iMenuTarget=null,swap=!1,currentmode=parseInt($("input:radio[name=mode]:checked").val(),10),imag="",stagcount=0,currentmode!==4?(mapHeight=parseInt($("#height").val(),10),mapWidth=parseInt($("#width").val(),10)):(mapHeight=4,mapWidth=3),normalTileCount=mapHeight*mapWidth,maptype!==6?edgeTileCount=2*(mapHeight+mapWidth):edgeTileCount=2*mapHeight,$.post("scripts/load_morphs.php",{map_kind:maptype,artists:tileSetOptions},function(e){var t=$.parseJSON(e);mainTiles.stock(t[1]),edgeTiles.stock(t[2]),cornerTiles.stock(t[3]),maptype!==6&&(topTiles.stock(t[4]),tcoTiles.stock(t[5]),btmTiles.stock(t[6]),bcoTiles.stock(t[7])),composeMap(mapWidth,mapHeight)})},selectTileSets=function(){"use strict";tileSetOptions="",$("#artistsblock input").filter(":checked").each(function(){tileSetOptions+=$(this).val()+","}),tileSetOptions=tileSetOptions.substr(0,tileSetOptions.length-1),drawMap()},exportMap=function(){"use strict";if(currentmode===1||currentmode===3||currentmode===4||maptype===6){var e;$("#notification").slideUp("fast");if(mapWidth*mapHeight>36&&!confirm("Whoa there! Your browser might choke on saving a map of this size and crash the tab and/or window. Are you sure you want to let it run?"))return!1;artBoard.width=imgBoard.width()-2,artBoard.height=imgBoard.height(),currentmode===4&&(artBoard.width="900px",artBoard.height="1235px"),$("#tiles").find("img").each(function(){artMode.save(),mypos=$(this).position(),myrot=$(this).data("rot"),mywid=$(this).width(),myhei=$(this).height(),imgho.src=$(this).attr("src"),mypos.left-=22,mypos.top-=22,maptype===6?(artMode.translate(mypos.left+mywid/2,mypos.top+myhei/2),myrot%2===1&&artMode.scale(-1,1)):(myrot%2===1&&mywid>150&&myhei<300&&(mypos.left-=150,mypos.top+=75),artMode.translate(mypos.left+mywid/2,mypos.top+myhei/2),artMode.rotate(myrot*Math.PI/2)),artMode.drawImage(imgho,-(mywid/2),-(myhei/2),mywid,myhei),artMode.restore()}),$("#grid").find("img").each(function(){artMode.save(),mypos=$(this).position(),mywid=$(this).width(),myhei=$(this).height(),imgho.src=$(this).attr("src"),artMode.translate(mypos.left+mywid/2,mypos.top+myhei/2),artMode.drawImage(imgho,-(mywid/2),-(myhei/2),mywid,myhei),artMode.restore()}),e=artBoard.toDataURL("image/png"),window.open(e,"MapWindow","width=800,height=600,scrollbars=yes"),artBoard.width=artBoard.width*2/2}else{var t,n;mapWidth*mapHeight>64?($("#notification span").text("This map looks too big to export to PNG without causing an error. Sorry!"),$("#notification").slideDown("fast")):($("#notification").slideUp("fast"),n={tiles:[],rotation:[]},$("#tiles img").each(function(e){n.tiles[e]=$(this).data("imgid"),n.rotation[e]=$(this).data("rot")}),t="fullmap.php?mapData="+base64_encode(JSON.stringify(n))+"&w="+mapWidth+"&h="+mapHeight,endcaps?t+="&e=1":t+="&e=0",corners?t+="&c=1":t+="&c=0",t+="&g="+(gridsize===0?"0":gridsize),window.open(t,"MapWindow","width=800,height=600,scrollbars=yes"))}buggedyet!==1&&(confirm("Dave here. Thanks for using my mapper! I hate to ask, but would you be interested in taking me on a virtual Taco Bell run?")&&window.open("https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=GVMXRJ6VVXLMY","DonateWindow"),buggedyet=1,createCookie("buggedyet",1,365))},replaceTile=function(e,t,n,r){"use strict";r&&($("#notification span").text("Exit tiles had to be temporarily disabled while optimizations were made to keep the site online. Sorry!"),$("#notification").slideDown("fast"));var i;switch(n){case 2:i=edgeTiles.draw();break;case 3:i=cornerTiles.draw();break;case 4:i=topTiles.draw();break;case 5:i=tcoTiles.draw();break;case 6:i=btmTiles.draw();break;case 7:i=bcoTiles.draw();break;default:i=mainTiles.draw()}console.log(n,i),e.attr("src","../tiles/"+i.image).data("imgid",i.id).data("artist",i.artist_id)},nextGrid=function(){"use strict";switch(parseInt(gridsize,10)+1){case 1:$("#grid5").click();break;case 2:$("#grid10").click();break;case 3:$("#gridhex").click();break;case 4:$("#nogrid").click()}},roomStock=function(){"use strict";var e,t,n,r,i;do{$("#roomcont").empty(),e=0;for(i=0;i<5;i+=1)t=randInt(0,11),e+=t,t<10?r="<li>"+roomContents[t]+"</li>":(n=randInt(0,specialContents.length-1),r="<li>Special: "+specialContents[n]+"</li>"),$("#roomcont").append(r)}while(e===0);_gaq.push(["_trackEvent","Room Stocker","Stock"])};$(document).ready(function(){"use strict";imgBoard=$("#tiles"),$("#newWindowB").click(exportMap),artBoard=document.getElementById("drawingboard"),artMode=artBoard.getContext("2d"),$("#newBtn").click(drawMap),$("input.mtBtn").click(function(){map_kind=parseInt($(this).val(),10)}),$("input:radio[name=maptype]").click(function(){$mobilemode&&$(this).blur(),maptype=parseInt($(this).val(),10),$("#artistsblock").load("scripts/load_authors.php",{map_kind:maptype},selectTileSets)}),$("#site-head").on("click tap","#nogrid",function(){$("#grid").css("background","transparent"),gridsize=0}).on("click tap","#grid5",function(){$("#grid").css("background","url(../grid_15.png)"),gridsize=1}).on("click tap","#grid10",function(){$("#grid").css("background","url(../grid_30.png)"),gridsize=2}).on("click tap","#gridhex",function(){$("#grid").css("background","url(../images/hex.png)"),gridsize=3}),$("#rotateTile").click(function(){if(!jQuery.inArray(iMenuTarget.data("type"),["tile","top","btm"])<0)return!1;var e=iMenuTarget.data("rot"),t=(e+1)%4;return iMenuTarget.data("rot",t).removeClass("rot"+e).addClass("rot"+t),!1}),$("#removeTile").click(function(){var e;switch(iMenuTarget.data("type")){case"tab":return;case"bco":e=7;break;case"btm":e=6;break;case"tco":e=5;break;case"top":e=4;break;case"corner":e=3;break;case"edge":e=2;break;default:e=1}return replaceTile(iMenuTarget,iMenuTarget.data("imgid"),e,!1),!1}),readCookie("popup")!=="original"&&$("#popup").show().click(function(){$(this).fadeOut("fast"),createCookie("popup","original",90)}),buggedyet=readCookie("buggedyet"),$("#tilepanel").find(".collapsed").hide(),$("#width").val(2),$("#height").val(2),currentmode=parseInt($("input:radio[name=mode]:checked").val(),10),gridsize=parseInt($("input:radio[name=grid]:checked").val(),10),maptype=parseInt($("input:radio[name=maptype]:checked").val(),10),$("#artistsblock").load("scripts/load_authors.php",{map_kind:maptype},selectTileSets),maptype===6?$("#viewport").addClass("sv").removeClass("nm"):$("#viewport").addClass("nm").removeClass("sv"),gridsize===1&&$("#grid").addClass("g15"),gridsize===2&&$("#grid").addClass("g30"),gridsize===3&&$("#grid").addClass("gh"),$("#fitwidth").is(":checked")&&(scaled=!0);if($mobilemode&&ua.indexOf("Android")>=0){var e=parseFloat(ua.slice(ua.indexOf("Android")+8));e<3&&$("body").addClass("faildroid")}$appmode&&($("body").css({"margin-bottom":"0"}),$("#map").css({"margin-top":"34px"}),$("#tilepanel,#site-head").css({top:"0"}),$("#notification,#popup").css({top:"62px;"}),$("#newnav,#site-foot").hide()),$("canvas#grid").length>0&&($("#grid").remove(),$("<div id='grid'></div>").appendTo("#map"))}).hammer().on("rotate",function(e){"use strict";if(iMenuTarget.data("type")=="tile"){var t=iMenuTarget.data("rot");inrotate=!0,detectedrotate=(t*90+Math.round(e.gesture.rotation)+360)%360,iMenuTarget.removeClass("rot"+t).css({"-webkit-transform":"rotateZ("+detectedrotate+"deg)","-moz-transform":"rotateZ("+detectedrotate+"deg)","-ms-transform":"rotateZ("+detectedrotate+"deg)","-o-transform":"rotateZ("+detectedrotate+"deg)",transform:"rotateZ("+detectedrotate+"deg)","-webkit-transition":"none","-moz-transition":"none","-ms-transition":"none","-o-transition":"none",transition:"none",zoom:1}),e.gesture.preventDefault()}}).on("release",function(e){"use strict";if(inrotate){inrotate=!1;var t=iMenuTarget.data("rot"),n=Math.round(detectedrotate/90)%4;iMenuTarget.data("rot",n).removeClass("rot"+t).addClass("rot"+n).css({"-webkit-transform":"","-moz-transform":"","-ms-transform":"","-o-transform":"",transform:"","-webkit-transition":"","-moz-transition":"","-ms-transition":"","-o-transition":"",transition:"",zoom:1}),detectedrotate=0}}).on("change","#artistsblock input",function(e){"use strict";e.metaKey&&($(this).prop("checked",!0).siblings("input").prop("checked",!1),alert("Test")),selectTileSets()}).on("dblclick","#artistsblock label",function(){"use strict";var e=$(this).attr("for");$("#"+e).prop("checked",!0).siblings("input").prop("checked",!1),selectTileSets()}).on("click tap","#removeTileExit",function(){"use strict";var e;switch(iMenuTarget.data("type")){case"tab":return;case"tco":e=5;break;case"top":e=4;break;case"corner":e=3;break;case"edge":e=2;break;default:e=1}return replaceTile(iMenuTarget,iMenuTarget.data("imgid"),e,!0),!1}).on("click tap","#swapTile",function(){"use strict";if(iMenuTarget.data("type")==="tab")return;return iMenuTarget.addClass("swapfirst"),swap=!0,$("#swapTile").addClass("down"),!1}).on("click tap","#mancrush",function(){"use strict";var e=iMenuTarget.data("artist");$("#chk"+e).prop("checked",!0).siblings("input").prop("checked",!1),selectTileSets()}).on("dragstart","#tiles img",function(e){"use strict";var t=e.originalEvent;if(swap)return;iMenuTarget=$(this),$(".selTile").removeClass("selTile"),iMenuTarget.addClass("selTile"),t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/html","Swap")}).on("dragover","#tiles img",function(e){var t=e.originalEvent;t.preventDefault()}).on("drop","#tiles img",function(e){"use strict";var t=e.originalEvent,n,r;t.preventDefault();if(t.dataTransfer.getData("text/html")=="Swap"){if(iMenuTarget.data("type")!==$(this).data("type"))return!1;n={image:iMenuTarget.attr("src"),id:iMenuTarget.data("imgid"),artist:iMenuTarget.data("artist"),rotation:iMenuTarget.data("rot")},r={image:$(this).attr("src"),id:$(this).data("imgid"),artist:$(this).data("artist"),rotation:$(this).data("rot")},iMenuTarget.attr("src",r.image).data("imgid",r.id).data("artist",r.artist).removeClass("swapfirst"),$(this).attr("src",n.image).data("imgid",n.id).data("artist",n.artist),$(this).data("type")=="tile"&&(iMenuTarget.data("rot",r.rotation).removeClass("rot"+n.rotation).addClass("rot"+r.rotation),$(this).data("rot",n.rotation).removeClass("rot"+r.rotation).addClass("rot"+n.rotation)),iMenuTarget=$(this),$(".selTile").removeClass("selTile"),iMenuTarget.addClass("selTile")}}).on("click tap","#tiles img",function(){"use strict";var e,t,n=10,r=10;if($(this).data("type")==="tab")return;if(swap){if(iMenuTarget.data("type")!==$(this).data("type"))return!1;e={image:iMenuTarget.attr("src"),id:iMenuTarget.data("imgid"),artist:iMenuTarget.data("artist"),rotation:iMenuTarget.data("rot")},t={image:$(this).attr("src"),id:$(this).data("imgid"),artist:$(this).data("artist"),rotation:$(this).data("rot")},iMenuTarget.attr("src",t.image).data("imgid",t.id).data("artist",t.artist).removeClass("swapfirst"),$(this).attr("src",e.image).data("imgid",e.id).data("artist",e.artist),$(this).data("type")=="tile"&&(iMenuTarget.data("rot",t.rotation).removeClass("rot"+e.rotation).addClass("rot"+t.rotation),$(this).data("rot",e.rotation).removeClass("rot"+t.rotation).addClass("rot"+e.rotation)),swap=!1,$("#swapTile").removeClass("down")}iMenuTarget=$(this),$(".selTile").removeClass("selTile"),iMenuTarget.addClass("selTile"),jQuery.inArray(iMenuTarget.data("type"),["tile","top","btm"])>-1?$("#rotateBtn").fadeTo("fast",1):$("#rotateBtn").fadeTo("fast",.5),$(this).hasClass("edge")&&($(this).hasClass("rot1")||$(this).hasClass("rot3"))&&(r-=75,navigator.userAgent.toLowerCase().indexOf("webkit")>-1&&(n+=75,r-=75),navigator.userAgent.toLowerCase().indexOf("opera")>-1&&(n+=75,r-=75))}).on("change","#width, #height",drawMap).on("click tap","#roomBtn",roomStock).on("click tap change","input:radio[name=mode]",function(){"use strict";currentmode=parseInt($(this).val(),10),drawMap()}).on("dblclick","#tiles img.tile",function(e){"use strict";var t=$(this),n,r;e.metaKey?replaceTile(t,t.data("imgid"),1,!1):(n=$(this).data("rot"),r=(n+1)%4,$(this).data("rot",r).removeClass("rot"+n).addClass("rot"+r))}).on("dblclick","#tiles img.edge",function(e){"use strict";if(e.metaKey){var t=$(this);replaceTile(t,t.data("imgid"),2,!1)}}).on("dblclick","#tiles img.corner",function(e){"use strict";if(e.metaKey){var t=$(this);replaceTile(t,t.data("imgid"),3,!1)}}).on("dblclick","#tiles img.top",function(e){"use strict";var t=$(this),n,r;e.metaKey?replaceTile(t,t.data("imgid"),4,!1):(n=$(this).data("rot"),r=(n+1)%2,$(this).data("rot",r).removeClass("rot"+n).addClass("rot"+r))}).on("dblclick","#tiles img.tco",function(e){"use strict";if(e.metaKey){var t=$(this);replaceTile(t,t.data("imgid"),5,!1)}}).on("dblclick","#tiles img.btm",function(e){"use strict";var t=$(this),n,r;e.metaKey?replaceTile(t,t.data("imgid"),6,!1):(n=$(this).data("rot"),r=(n+1)%2,$(this).data("rot",r).removeClass("rot"+n).addClass("rot"+r))}).on("dblclick","#tiles img.bco",function(e){"use strict";if(e.metaKey){var t=$(this);replaceTile(t,t.data("imgid"),7,!1)}}).on("click","#grid",function(e){"use strict";if($(this).hasClass("iconmode"))var t=$(this).offset(),n=e.clientX-t.left-15,r=e.clientY-t.top-15,i=$("<img />").attr("src","../images/fab.png").css({top:r+"px",left:n+"px",width:"30px"}).appendTo($(this))}).bind("keydown","c",function(){"use strict";$("#endBtn").click(),drawMap()}).bind("keydown","f",function(){"use strict";$("#fitwidth").click()}).bind("keydown","g",nextGrid).bind("keydown","n",drawMap).bind("keydown","shift+n",function(){"use strict";$("#normal").click(),drawMap()}).bind("keydown","shift+y",function(){"use strict";$("#grid").toggleClass("iconmode")}).bind("keydown","s",function(){"use strict";$("#stagger").click(),drawMap()}).bind("keydown","shift+s",function(){"use strict";$("#stagcap").click(),drawMap()}).bind("keydown","shift+c",function(){"use strict";$("span.amt, span.special").slideToggle("slow")}),"standalone"in navigator&&!navigator.standalone&&$mobilemode&&$issafari&&($('<link rel="stylesheet" href="/style/add2home.css" />').appendTo("body"),$('<script src="/scripts/add2home.js"></script>').appendTo("body"));