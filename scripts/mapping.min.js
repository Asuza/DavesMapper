var TileDeck,artBoard,artMode,imgBoard,mypos,myrot,mywid,myhei,mapSettings={mode:0,height:2,width:2,hasEndcaps:!1,gridType:0},corners,endstag,map_kind,scaled=!1,swap=!1,inrotate=!1,maptype=1,stagcount=0,tilecount=0,normalTileCount=0,edgeTileCount=0,detectedrotate=0,tileSetOptions="",imag="",selectedTile,roomContents=["Empty","Monster(s) and Treasure","Monster(s) and Treasure","Empty, Hidden Treasure","Trap, Treasure","Trap","Monster(s)","Monster(s)","Monster(s)","Monster(s)"],specialContents=["Hindrance","Danger","Advantage","Mystery","Special Creature","Odor","Power"],$issafari=/Safari/i.test(window.navigator.appVersion),ua=window.navigator.userAgent,tileLibrary={};TileDeck=function(){"use strict";this.deck=[],this.cursor=0},TileDeck.prototype.shuffle=function(){"use strict";this.deck.sort(function(){return Math.round(Math.random())-.5})},TileDeck.prototype.draw=function(){var e=this.deck[this.cursor];return this.cursor+=1,this.cursor%this.deck.length===0&&(this.cursor=0,this.shuffle()),e},TileDeck.prototype.stock=function(e){this.deck=e||[],this.cursor=0,this.shuffle()},tileLibrary={tile:new TileDeck,edge:new TileDeck,corner:new TileDeck,top:new TileDeck,tco:new TileDeck,btm:new TileDeck,bco:new TileDeck};var createCookie=function(e,t,n){var r,i;n?(r=new Date,r.setTime(r.getTime()+n*24*60*60*1e3),i="; expires="+r.toGMTString()):i="",document.cookie=e+"="+t+i+"; path=/"},readCookie=function(e){var t=e+"=",n=document.cookie.split(";"),r,i;for(r=0;r<n.length;r+=1){i=n[r];while(i.charAt(0)===" ")i=i.substring(1,i.length);if(i.indexOf(t)===0)return i.substring(t.length,i.length)}return null},eraseCookie=function(e){createCookie(e,"",-1)},appendTab=function(e){$("#tiles").append("<img class='tab rot"+e+"' data-rot='"+e+"' data-type='tab' src='../images/tab.png'/>")},appendTile=function(e,t){var n=tileLibrary[e].draw();$("#tiles").append("<img draggable='true' class='"+e+" rot"+t+"' data-rot='"+t+"' data-type='"+e+"' data-imgid='"+n.id+"' data-artist='"+n.artist_id+"' src='../tiles/"+n.image+"'/>")},applyGridOverlay=function(e){mapSettings.gridType=parseInt(e,10);switch(mapSettings.gridType){case 1:$("#grid").css("background","url(../grid_15.png)");break;case 2:$("#grid").css("background","url(../grid_30.png)");break;case 3:$("#grid").css("background","url(../images/hex.png)");break;default:$("#grid").css("background","transparent")}},composeMap=function(e,t){var n,r,i,s,o,u,a,f;endstag=tileLibrary.edge.deck.length>0&&mapSettings.mode===3,mapSettings.hasEndcaps=tileLibrary.edge.deck.length>0&&mapSettings.mode===2,corners=tileLibrary.corner.deck.length>0&&mapSettings.mode===2,maptype===6?(n=tileLibrary.top.deck.length>0&&mapSettings.mode===2,i=tileLibrary.tco.deck.length>0&&mapSettings.mode===2,r=tileLibrary.btm.deck.length>0&&mapSettings.mode===2,s=tileLibrary.bco.deck.length>0&&mapSettings.mode===2,$("#viewport").removeClass("nm").addClass("sv"),$("#notification").slideUp("fast")):($("#viewport").removeClass("sv").addClass("nm"),mapSettings.mode!==2&&mapSettings.mode!==3||tileLibrary.edge.deck.length!==0&&tileLibrary.corner.deck.length!==0?$("#notification").slideUp("fast"):($("#notification span").text("The tile sets you selected do not contain the right tile mix for your selected map mode. Falling back to the closest possible map mode."),$("#notification").slideDown("fast")));if(mapSettings.mode!==4){o=300*e+2,mapSettings.hasEndcaps&&(o+=300),$("#map, #tiles").width(o+"px"),$("#tiles").empty();if(maptype!==6){if(mapSettings.hasEndcaps){corners&&appendTile("corner",0);for(a=0;a<e-stagcount;a+=1)appendTile("edge",0);corners&&appendTile("corner",1),$("#tiles").append("<br/>")}}else if(n){i&&appendTile("tco",0);for(a=0;a<e-stagcount;a+=1)appendTile("top",0);i&&appendTile("tco",1),$("#tiles").append("<br/>")}for(u=0;u<t;u+=1){f=maptype===6?0:3,(mapSettings.hasEndcaps||endstag&&stagcount===1)&&appendTile("edge",f);for(a=0;a<e-stagcount;a+=1)appendTile("tile",randInt(0,3));(mapSettings.hasEndcaps||endstag&&stagcount===1)&&appendTile("edge",1);if(mapSettings.mode===1||mapSettings.mode===3)stagcount=1-stagcount;$("#tiles").append("<br/>")}if(maptype!==6){if(mapSettings.hasEndcaps){corners&&appendTile("corner",3);for(a=0;a<e-stagcount;a+=1)appendTile("edge",2);corners&&appendTile("corner",2),$("#tiles").append("<br/>")}}else if(r){s&&appendTile("bco",0);for(a=0;a<e-stagcount;a+=1)appendTile("btm",0);s&&appendTile("bco",1),$("#tiles").append("<br/>")}}else $("#map, #tiles").width("902px"),$("#tiles").empty(),appendTab(0),appendTile("tile",randInt(0,3)),appendTab(2),$("#tiles").append("<br/>"),appendTile("tile",randInt(0,3)),appendTile("tile",randInt(0,3)),appendTile("tile",randInt(0,3)),$("#tiles").append("<br/>"),appendTab(0),appendTile("tile",randInt(0,3)),appendTab(2),$("#tiles").append("<br/>"),appendTab(0),appendTile("tile",randInt(0,3)),appendTab(2),$("#tiles").append("<br/>"),$("#tiles").append("<img class='rot0' data-rot='0' data-type='tab' src='../images/tab_bottom.png'/>");tilecount=$("#tiles img").length},generateMap=function(){selectedTile=null,swap=!1,mapSettings.mode=parseInt($("input:radio[name=mode]:checked").val(),10),imag="",stagcount=0,mapSettings.mode!==4?(mapSettings.height=parseInt($("#height").val(),10),mapSettings.width=parseInt($("#width").val(),10)):(mapSettings.height=4,mapSettings.width=3),normalTileCount=mapSettings.height*mapSettings.width,maptype!==6?edgeTileCount=2*(mapSettings.height+mapSettings.width):edgeTileCount=2*mapSettings.height,$.post("scripts/load_morphs.php",{map_kind:maptype,artists:tileSetOptions},function(e){var t=$.parseJSON(e);tileLibrary.tile.stock(t[1]),tileLibrary.edge.stock(t[2]),tileLibrary.corner.stock(t[3]),maptype!==6&&(tileLibrary.top.stock(t[4]),tileLibrary.tco.stock(t[5]),tileLibrary.btm.stock(t[6]),tileLibrary.bco.stock(t[7])),composeMap(mapSettings.width,mapSettings.height)})},selectTileSets=function(){tileSetOptions="",$("#artistsblock input").filter(":checked").each(function(){tileSetOptions+=$(this).val()+","}),tileSetOptions=tileSetOptions.substr(0,tileSetOptions.length-1),generateMap()},exportMap=function(){var e=new Image;if(mapSettings.mode===1||mapSettings.mode===3||mapSettings.mode===4||maptype===6){var t;$("#notification").slideUp("fast");if(mapSettings.width*mapSettings.height>36&&!confirm("Whoa there! Your browser might choke on saving a map of this size and crash the tab and/or window. Are you sure you want to let it run?"))return!1;artBoard.width=imgBoard.width()-2,artBoard.height=imgBoard.height(),mapSettings.mode===4&&(artBoard.width="900px",artBoard.height="1235px"),$("#tiles").find("img").each(function(){artMode.save(),mypos=$(this).position(),myrot=$(this).data("rot"),mywid=$(this).width(),myhei=$(this).height(),e.src=$(this).attr("src"),mypos.left-=22,mypos.top-=22,maptype===6?(artMode.translate(mypos.left+mywid/2,mypos.top+myhei/2),myrot%2===1&&artMode.scale(-1,1)):(myrot%2===1&&mywid>150&&myhei<300&&(mypos.left-=150,mypos.top+=75),artMode.translate(mypos.left+mywid/2,mypos.top+myhei/2),artMode.rotate(myrot*Math.PI/2)),artMode.drawImage(e,-(mywid/2),-(myhei/2),mywid,myhei),artMode.restore()}),$("#grid").find("img").each(function(){artMode.save(),mypos=$(this).position(),mywid=$(this).width(),myhei=$(this).height(),e.src=$(this).attr("src"),artMode.translate(mypos.left+mywid/2,mypos.top+myhei/2),artMode.drawImage(e,-(mywid/2),-(myhei/2),mywid,myhei),artMode.restore()}),t=artBoard.toDataURL("image/png"),window.open(t,"MapWindow","width=800,height=600,scrollbars=yes"),artBoard.width=artBoard.width*2/2}else{var n,r;mapSettings.width*mapSettings.height>64?($("#notification span").text("This map looks too big to export to PNG without causing an error. Sorry!"),$("#notification").slideDown("fast")):($("#notification").slideUp("fast"),r={tiles:[],rotation:[]},$("#tiles img").each(function(e){r.tiles[e]=$(this).data("imgid"),r.rotation[e]=$(this).data("rot")}),n="fullmap.php?mapData="+base64_encode(JSON.stringify(r))+"&w="+mapSettings.width+"&h="+mapSettings.height,mapSettings.hasEndcaps?n+="&e=1":n+="&e=0",corners?n+="&c=1":n+="&c=0",n+="&g="+(mapSettings.gridType===0?"0":mapSettings.gridType),window.open(n,"MapWindow","width=800,height=600,scrollbars=yes"))}},replaceTile=function(e,t,n,r){var i=tileLibrary[n].draw();r&&($("#notification span").text("Exit tiles had to be temporarily disabled while optimizations were made to keep the site online. Sorry!"),$("#notification").slideDown("fast")),e.attr("src","../tiles/"+i.image).data("imgid",i.id).data("artist",i.artist_id)},nextGrid=function(){applyGridOverlay((mapSettings.gridType+1)%4)},roomStock=function(){var e,t,n,r,i;do{$("#roomcont").empty(),e=0;for(i=0;i<5;i+=1)t=randInt(0,11),e+=t,t<10?r="<li>"+roomContents[t]+"</li>":(n=randInt(0,specialContents.length-1),r="<li>Special: "+specialContents[n]+"</li>"),$("#roomcont").append(r)}while(e===0);ga("send","event","Room Stocker","Stock")};$(document).ready(function(){imgBoard=$("#tiles"),$("#newWindowB").click(exportMap),artBoard=document.getElementById("drawingboard"),artMode=artBoard.getContext("2d"),$("#newBtn").click(generateMap),$("input.mtBtn").click(function(){map_kind=parseInt($(this).val(),10)}),$("input:radio[name=maptype]").click(function(){$mobilemode&&$(this).blur(),maptype=parseInt($(this).val(),10),$("#artistsblock").load("scripts/load_authors.php",{map_kind:maptype},selectTileSets)}),$("#site-head").on("click tap","#nogrid",function(){applyGridOverlay(0)}).on("click tap","#grid5",function(){applyGridOverlay(1)}).on("click tap","#grid10",function(){applyGridOverlay(2)}).on("click tap","#gridhex",function(){applyGridOverlay(3)}),$("#rotateTile").click(function(){if(jQuery.inArray(selectedTile.data("type"),["tile","top","btm"])<0)return!1;var e=selectedTile.data("rot"),t=(e+1)%4;return selectedTile.data("rot",t).removeClass("rot"+e).addClass("rot"+t),!1}),$("#removeTile").click(function(){return replaceTile(selectedTile,selectedTile.data("imgid"),selectedTile.data("type"),!1),!1}),readCookie("popup")!=="original"&&$("#popup").show().click(function(){$(this).fadeOut("fast"),createCookie("popup","original",90)}),$("#tilepanel").find(".collapsed").hide(),$("#width").val(2),$("#height").val(2),mapSettings.mode=parseInt($("input:radio[name=mode]:checked").val(),10),applyGridOverlay($("input:radio[name=grid]:checked").val()),maptype=parseInt($("input:radio[name=maptype]:checked").val(),10),$("#artistsblock").load("scripts/load_authors.php",{map_kind:maptype},selectTileSets),maptype===6?$("#viewport").addClass("sv").removeClass("nm"):$("#viewport").addClass("nm").removeClass("sv"),$("#fitwidth").is(":checked")&&(scaled=!0);if($mobilemode&&ua.indexOf("Android")>=0){var e=parseFloat(ua.slice(ua.indexOf("Android")+8));e<3&&$("body").addClass("faildroid")}$appmode&&($("body").css({"margin-bottom":"0"}),$("#map").css({"margin-top":"34px"}),$("#tilepanel,#site-head").css({top:"0"}),$("#notification,#popup").css({top:"62px;"}),$("#newnav,#site-foot").hide()),$("canvas#grid").length>0&&($("#grid").remove(),$("<div id='grid'></div>").appendTo("#map"))}).hammer().on("rotate",function(e){if(selectedTile.data("type")=="tile"){var t=selectedTile.data("rot");inrotate=!0,detectedrotate=(t*90+Math.round(e.gesture.rotation)+360)%360,selectedTile.removeClass("rot"+t).css({"-webkit-transform":"rotateZ("+detectedrotate+"deg)","-moz-transform":"rotateZ("+detectedrotate+"deg)","-ms-transform":"rotateZ("+detectedrotate+"deg)","-o-transform":"rotateZ("+detectedrotate+"deg)",transform:"rotateZ("+detectedrotate+"deg)","-webkit-transition":"none","-moz-transition":"none","-ms-transition":"none","-o-transition":"none",transition:"none",zoom:1}),e.gesture.preventDefault()}}).on("release",function(e){if(inrotate){inrotate=!1;var t=selectedTile.data("rot"),n=Math.round(detectedrotate/90)%4;selectedTile.data("rot",n).removeClass("rot"+t).addClass("rot"+n).css({"-webkit-transform":"","-moz-transform":"","-ms-transform":"","-o-transform":"",transform:"","-webkit-transition":"","-moz-transition":"","-ms-transition":"","-o-transition":"",transition:"",zoom:1}),detectedrotate=0}}).on("change","#artistsblock input",function(e){e.metaKey&&($(this).prop("checked",!0).siblings("input").prop("checked",!1),alert("Test")),selectTileSets()}).on("dblclick","#artistsblock label",function(){var e=$(this).attr("for");$("#"+e).prop("checked",!0).siblings("input").prop("checked",!1),selectTileSets()}).on("click tap","#removeTileExit",function(){return replaceTile(selectedTile,selectedTile.data("imgid"),selectedTile.data("type"),!0),!1}).on("click tap","#swapTile",function(){if(selectedTile.data("type")==="tab")return;return selectedTile.addClass("swapfirst"),swap=!0,$("#swapTile").addClass("down"),!1}).on("click tap","#mancrush",function(){var e=selectedTile.data("artist");$("#chk"+e).prop("checked",!0).siblings("input").prop("checked",!1),selectTileSets()}).on("dragstart","#tiles img",function(e){var t=e.originalEvent;if(swap)return;selectedTile=$(this),$(".selTile").removeClass("selTile"),selectedTile.addClass("selTile"),t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/html","Swap")}).on("dragover","#tiles img",function(e){e.originalEvent.preventDefault()}).on("drop","#tiles img",function(e){var t,n;e=e.originalEvent,e.preventDefault();if(e.dataTransfer.getData("text/html")=="Swap"){if(selectedTile.data("type")!==$(this).data("type"))return!1;t={image:selectedTile.attr("src"),id:selectedTile.data("imgid"),artist:selectedTile.data("artist"),rotation:selectedTile.data("rot")},n={image:$(this).attr("src"),id:$(this).data("imgid"),artist:$(this).data("artist"),rotation:$(this).data("rot")},selectedTile.attr("src",n.image).data("imgid",n.id).data("artist",n.artist).removeClass("swapfirst"),$(this).attr("src",t.image).data("imgid",t.id).data("artist",t.artist),$(this).data("type")=="tile"&&(selectedTile.data("rot",n.rotation).removeClass("rot"+t.rotation).addClass("rot"+n.rotation),$(this).data("rot",t.rotation).removeClass("rot"+n.rotation).addClass("rot"+t.rotation)),selectedTile=$(this),$(".selTile").removeClass("selTile"),selectedTile.addClass("selTile")}}).on("click tap","#tiles img",function(){var e,t,n=10,r=10;if($(this).data("type")==="tab")return;if(swap){if(selectedTile.data("type")!==$(this).data("type"))return!1;e={image:selectedTile.attr("src"),id:selectedTile.data("imgid"),artist:selectedTile.data("artist"),rotation:selectedTile.data("rot")},t={image:$(this).attr("src"),id:$(this).data("imgid"),artist:$(this).data("artist"),rotation:$(this).data("rot")},selectedTile.attr("src",t.image).data("imgid",t.id).data("artist",t.artist).removeClass("swapfirst"),$(this).attr("src",e.image).data("imgid",e.id).data("artist",e.artist),$(this).data("type")=="tile"&&(selectedTile.data("rot",t.rotation).removeClass("rot"+e.rotation).addClass("rot"+t.rotation),$(this).data("rot",e.rotation).removeClass("rot"+t.rotation).addClass("rot"+e.rotation)),swap=!1,$("#swapTile").removeClass("down")}selectedTile=$(this),$(".selTile").removeClass("selTile"),selectedTile.addClass("selTile"),jQuery.inArray(selectedTile.data("type"),["tile","top","btm"])>-1?$("#rotateBtn").fadeTo("fast",1):$("#rotateBtn").fadeTo("fast",.5),$(this).hasClass("edge")&&($(this).hasClass("rot1")||$(this).hasClass("rot3"))&&(r-=75,ua.toLowerCase().indexOf("webkit")>-1&&(n+=75,r-=75),ua.toLowerCase().indexOf("opera")>-1&&(n+=75,r-=75))}).on("change","#width, #height",generateMap).on("click tap","#roomBtn",roomStock).on("click tap change","input:radio[name=mode]",function(){mapSettings.mode=parseInt($(this).val(),10),generateMap()}).on("dblclick","#tiles img.tile",function(e){var t=$(this),n,r;e.metaKey?replaceTile(t,t.data("imgid"),"tile",!1):(n=$(this).data("rot"),r=(n+1)%4,$(this).data("rot",r).removeClass("rot"+n).addClass("rot"+r))}).on("dblclick","#tiles img.edge",function(e){if(e.metaKey){var t=$(this);replaceTile(t,t.data("imgid"),"edge",!1)}}).on("dblclick","#tiles img.corner",function(e){if(e.metaKey){var t=$(this);replaceTile(t,t.data("imgid"),"corner",!1)}}).on("dblclick","#tiles img.top",function(e){var t=$(this),n,r;e.metaKey?replaceTile(t,t.data("imgid"),"top",!1):(n=$(this).data("rot"),r=(n+1)%2,$(this).data("rot",r).removeClass("rot"+n).addClass("rot"+r))}).on("dblclick","#tiles img.tco",function(e){if(e.metaKey){var t=$(this);replaceTile(t,t.data("imgid"),"tco",!1)}}).on("dblclick","#tiles img.btm",function(e){var t=$(this),n,r;e.metaKey?replaceTile(t,t.data("imgid"),"btm",!1):(n=$(this).data("rot"),r=(n+1)%2,$(this).data("rot",r).removeClass("rot"+n).addClass("rot"+r))}).on("dblclick","#tiles img.bco",function(e){if(e.metaKey){var t=$(this);replaceTile(t,t.data("imgid"),"bco",!1)}}).on("click","#grid",function(e){if($(this).hasClass("iconmode"))var t=$(this).offset(),n=e.clientX-t.left-15,r=e.clientY-t.top-15,i=$("<img />").attr("src","../images/fab.png").css({top:r+"px",left:n+"px",width:"30px"}).appendTo($(this))}).bind("keydown","c",function(){$("#endBtn").click(),generateMap()}).bind("keydown","f",function(){$("#fitwidth").click()}).bind("keydown","g",nextGrid).bind("keydown","n",generateMap).bind("keydown","shift+n",function(){$("#normal").click(),generateMap()}).bind("keydown","shift+y",function(){$("#grid").toggleClass("iconmode")}).bind("keydown","s",function(){$("#stagger").click(),generateMap()}).bind("keydown","shift+s",function(){$("#stagcap").click(),generateMap()}).bind("keydown","shift+c",function(){$("span.amt, span.special").slideToggle("slow")}),"standalone"in window.navigator&&!window.navigator.standalone&&$mobilemode&&$issafari&&($('<link rel="stylesheet" href="/style/add2home.css" />').appendTo("body"),$('<script src="/scripts/add2home.js"></script>').appendTo("body"));