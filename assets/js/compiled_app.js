function base64_encode(j){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var d,c,b,n,m,l,k,o,h=0,p=0,g="",f=[];if(!j){return j}j=unescape(encodeURIComponent(j));do{d=j.charCodeAt(h++);c=j.charCodeAt(h++);b=j.charCodeAt(h++);o=d<<16|c<<8|b;n=o>>18&63;m=o>>12&63;l=o>>6&63;k=o&63;f[p++]=e.charAt(n)+e.charAt(m)+e.charAt(l)+e.charAt(k)}while(h<j.length);g=f.join("");var a=j.length%3;return(a?g.slice(0,a-3):g)+"===".slice(a||3)}var JSON;if(!JSON){JSON={}}(function(){function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==="string"){k=rep[i];v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}}());function utf8_encode(a){if(a===null||typeof a==="undefined"){return""}var i=(a+"");var j="",b,e,c=0;b=e=0;c=i.length;for(var d=0;d<c;d++){var h=i.charCodeAt(d);var g=null;if(h<128){e++}else{if(h>127&&h<2048){g=String.fromCharCode((h>>6)|192,(h&63)|128)}else{if((h&63488)!=55296){g=String.fromCharCode((h>>12)|224,((h>>6)&63)|128,(h&63)|128)}else{if((h&64512)!=55296){throw new RangeError("Unmatched trail surrogate at "+d)}var f=i.charCodeAt(++d);if((f&64512)!=56320){throw new RangeError("Unmatched lead surrogate at "+(d-1))}h=((h&1023)<<10)+(f&1023)+65536;g=String.fromCharCode((h>>18)|240,((h>>12)&63)|128,((h>>6)&63)|128,(h&63)|128)}}}if(g!==null){if(e>b){j+=i.slice(b,e)}j+=g;b=e=d+1}}if(e>b){j+=i.slice(b,c)}return j}var TileDeck,artBoard,artMode,imgBoard,corners,tilecount=0,detectedrotate=0,$issafari=((/Safari/i).test(window.navigator.appVersion)),ua=window.navigator.userAgent,tileLibrary={},MAPPER,GUI;(function(a){a.isRotating=false;a.isSwapping=false;a.selectedTile=undefined;a.staggeredCappedMode=undefined;a.settings={structure:-1,theme:1,height:2,width:2,hasEndcaps:false,gridType:0,lineup:{},roster:[]};a.selectTile=function(c){var b=a;if(b.selectedTile){b.selectedTile.removeClass("selected-tile")}b.selectedTile=c;if(b.selectedTile){b.selectedTile.addClass("selected-tile");if(jQuery.inArray(MAPPER.selectedTile.data("type"),["tile","top","btm"])>-1){$("#rotateBtn").fadeTo("fast",1)}else{$("#rotateBtn").fadeTo("fast",0.5)}}};a.performSwap=function(f){var e=this.selectedTile,c=f,d,b;if(e.data("type")!==c.data("type")){return false}d={image:e.attr("src"),id:e.data("imgid"),artist:e.data("artist"),rotation:e.data("rot")};b={image:c.attr("src"),id:c.data("imgid"),artist:c.data("artist"),rotation:c.data("rot")};e.attr("src",b.image).data("imgid",b.id).data("artist",b.artist).removeClass("swapfirst");c.attr("src",d.image).data("imgid",d.id).data("artist",d.artist);if(c.data("type")==="tile"){e.data("rot",b.rotation).removeClass("rot"+d.rotation).addClass("rot"+b.rotation);c.data("rot",d.rotation).removeClass("rot"+b.rotation).addClass("rot"+d.rotation)}this.isSwapping=false;$("#swapTileBtn").removeClass("down")};a.detectStructure=function(){var b=a;b.settings.structure=parseInt($("input:radio[name=mode]:checked").val(),10);return b.settings.structure};a.newMap=function(){var t=a,s=document.getElementById("tiles"),b=t.detectStructure(),g=b,p=t.settings,e=0,h,k,d,f,u,l,c,n,m,q;t.selectTile();t.isSwapping=false;if(b!==4){h=parseInt($("#height").val(),10);k=parseInt($("#width").val(),10)}else{h=4;k=3}p.width=k;p.height=h;t.staggeredCappedMode=((tileLibrary.edge.deck.length>0)&&(b===3));p.hasEndcaps=((tileLibrary.edge.deck.length>0)&&(b===2));corners=((tileLibrary.corner.deck.length>0)&&(b===2));if(p.theme===6){d=((tileLibrary.top.deck.length>0)&&(b===2));u=((tileLibrary.tco.deck.length>0)&&(b===2));f=((tileLibrary.btm.deck.length>0)&&(b===2));l=((tileLibrary.bco.deck.length>0)&&(b===2));$("#viewport").removeClass("nm").addClass("sv");GUI.hideNotification()}else{$("#viewport").removeClass("sv").addClass("nm");if(((b===2)||(b===3))&&((tileLibrary.edge.deck.length===0)||(tileLibrary.corner.deck.length===0))){GUI.showNotification("The tile sets you selected do not contain the right tile mix for your selected map structure. Falling back to the closest possible map structure.")}else{GUI.hideNotification()}}if(b!==4){c=300*k+2;if(p.hasEndcaps){c+=300}$("#map, #tiles").width(c+"px");while(s.firstChild){s.removeChild(s.firstChild)}if(p.theme!==6){if(p.hasEndcaps){if(corners){appendTile("corner",0)}for(m=0;m<k-e;m+=1){appendTile("edge",0)}if(corners){appendTile("corner",1)}s.appendChild(document.createElement("br"))}}else{if(d){if(u){appendTile("tco",0)}for(m=0;m<k-e;m+=1){appendTile("top",0)}if(u){appendTile("tco",1)}s.appendChild(document.createElement("br"))}}for(n=0;n<h;n+=1){q=(p.theme===6)?0:3;if(p.hasEndcaps||(a.staggeredCappedMode&&(e===1))){appendTile("edge",q)}for(m=0;m<k-e;m+=1){appendTile("tile",randInt(0,3))}if(p.hasEndcaps||(a.staggeredCappedMode&&(e===1))){appendTile("edge",1)}if((b===1)||(b===3)){e=1-e}s.appendChild(document.createElement("br"))}if(p.theme!==6){if(p.hasEndcaps){if(corners){appendTile("corner",3)}for(m=0;m<k-e;m+=1){appendTile("edge",2)}if(corners){appendTile("corner",2)}s.appendChild(document.createElement("br"))}}else{if(f){if(l){appendTile("bco",0)}for(m=0;m<k-e;m+=1){appendTile("btm",0)}if(l){appendTile("bco",1)}s.appendChild(document.createElement("br"))}}}else{$("#map, #tiles").width("902px");var r=document.getElementById("tiles");while(r.firstChild){r.removeChild(r.firstChild)}appendTab(0);appendTile("tile",randInt(0,3));appendTab(2);s.appendChild(document.createElement("br"));appendTile("tile",randInt(0,3));appendTile("tile",randInt(0,3));appendTile("tile",randInt(0,3));s.appendChild(document.createElement("br"));appendTab(0);appendTile("tile",randInt(0,3));appendTab(2);s.appendChild(document.createElement("br"));appendTab(0);appendTile("tile",randInt(0,3));appendTab(2);s.appendChild(document.createElement("br"));var o=document.createElement("img");o.setAttribute("class","rot0");o.setAttribute("data-rot","0");o.setAttribute("data-type","tab");o.setAttribute("src","../images/tab_bottom.png");s.appendChild(o)}tilecount=$("#tiles img").length};a.applyGridOverlay=function(c){var d=a,e=document.getElementById("grid"),b={0:"transparent",1:"url(/grid_15.png)",2:"url(/grid_30.png)",3:"url(/images/hex.png)"};d.settings.gridType=parseInt(c,10);e.style.background=b[d.settings.gridType]||"transparent";ga("send","event","Grid","Type "+c)};a.nextGrid=function(){a.applyGridOverlay((a.settings.gridType+1)%4)}})(window.MAPPER=window.MAPPER||{});MAPPER=window.MAPPER;(function(a){a.init=function(){a.notificationHolder=$("#notification");a.notificationTextHolder=a.notificationHolder.find("span");a.notificationHolder.on("click","#clearNotificationButton",a.hideNotification);a.modalContainer=$("#popup");a.modalContentContainer=a.modalContainer.find("div");a.modalContainer.click(function(){$(this).fadeOut("fast")})};a.showNotification=function(b){a.notificationTextHolder.text(b);a.notificationHolder.slideDown("fast")};a.hideNotification=function(){a.notificationHolder.slideUp("fast")};a.showModal=function(b){a.modalContentContainer.html(b);a.modalContainer.show()}})(window.GUI=window.GUI||{});GUI=window.GUI;TileDeck=function(){this.deck=[];this.dataSource=[];this.cursor=0};TileDeck.prototype.shuffle=function(){var b=this.deck,a,d,c;this.cursor=0;for(d=b.length-1;d>0;d--){c=Math.floor(Math.random()*(d+1));a=b[d];b[d]=b[c];b[c]=a}this.deck=b};TileDeck.prototype.filter=function(){this.deck=this.dataSource.filter(function(a){return MAPPER.settings.lineup[a.artist_id]});this.shuffle()};TileDeck.prototype.draw=function(){var a=this.deck[this.cursor];this.cursor+=1;if((this.cursor%this.deck.length)===0){this.shuffle()}return a};TileDeck.prototype.stock=function(a){this.dataSource=a||[];this.filter()};tileLibrary={tile:new TileDeck(),edge:new TileDeck(),corner:new TileDeck(),top:new TileDeck(),tco:new TileDeck(),btm:new TileDeck(),bco:new TileDeck()};var createCookie=function(c,d,e){var b,a;if(e){b=new Date();b.setTime(b.getTime()+(e*24*60*60*1000));a="; expires="+b.toGMTString()}else{a=""}document.cookie=c+"="+d+a+"; path=/"},readCookie=function(b){var e=b+"=",a=document.cookie.split(";"),d,f;for(d=0;d<a.length;d+=1){f=a[d];while(f.charAt(0)===" "){f=f.substring(1,f.length)}if(f.indexOf(e)===0){return f.substring(e.length,f.length)}}return null},eraseCookie=function(a){createCookie(a,"",-1)},appendTab=function(b){var c=document.createElement("img"),a=document.getElementById("tiles");c.classList.add("tab");c.classList.add("rot"+b);c.setAttribute("data-rot",b);c.setAttribute("data-type","tab");c.setAttribute("src","../images/tab.png");a.appendChild(c)},appendTile=function(d,c){var b=tileLibrary[d].draw(),e=document.createElement("img"),a=document.getElementById("tiles");e.classList.add(d);e.classList.add("rot"+c);e.setAttribute("data-rot",c);e.setAttribute("data-type",d);e.setAttribute("data-imgid",b.id);e.setAttribute("data-artist",b.artist_id);e.setAttribute("src","../tiles/"+b.image);e.setAttribute("draggable","true");a.appendChild(e)},loadRoster=function(){$.post("scripts/load_authors.php",{map_kind:MAPPER.settings.theme},onRosterDataLoaded)},onRosterDataLoaded=function(b){var f="",c=$.parseJSON(b),e=c.length,a={};MAPPER.settings.roster=c;for(var d=0;d<e;d++){a[c[d].artist_id]=true;f+="<input type='checkbox' name='tileset' class='panelChk'  id='chk"+c[d].artist_id+"' value='"+c[d].artist_id+"' checked /><label for='chk"+c[d].artist_id+"' data-artist='"+c[d].artist_id+"'><img src='../m_icons/"+c[d].icon+".png' /><span class='name'><span class='nick'>"+c[d].initials+"</span><span class='full'>"+c[d].name+"</span></span></label>"}MAPPER.settings.lineup=a;downloadTileData(selectTileSets);$("#artistsblock").html(f)},downloadTileData=function(a){$.post("scripts/load_morphs.php",{map_kind:MAPPER.settings.theme},function(c){var b=$.parseJSON(c);tileLibrary.tile.stock(b[1]);tileLibrary.edge.stock(b[2]);tileLibrary.corner.stock(b[3]);if(MAPPER.settings.theme===6){tileLibrary.top.stock(b[4]);tileLibrary.tco.stock(b[5]);tileLibrary.btm.stock(b[6]);tileLibrary.bco.stock(b[7])}if(a){a()}})},selectTileSets=function(){var a={};$("#artistsblock input").filter(":checked").each(function(){a[$(this).val()]=true});MAPPER.settings.lineup=a;tileLibrary.tile.filter();tileLibrary.edge.filter();tileLibrary.corner.filter();if(MAPPER.settings.theme===6){tileLibrary.top.filter();tileLibrary.tco.filter();tileLibrary.btm.filter();tileLibrary.bco.filter()}MAPPER.newMap()},exportMap=function(){var c=new Image(),a,d,b,h;if(MAPPER.settings.mode===4){GUI.showNotification("Export for cubes is currently not working. Please try your browser's print option instead.");ga("send","event","Export","Failed-Cube")}else{if((MAPPER.settings.mode===1)||(MAPPER.settings.mode===3)||(MAPPER.settings.mode===4)||(MAPPER.settings.theme===6)){var g;GUI.hideNotification();if((MAPPER.settings.width*MAPPER.settings.height)>36){if(!confirm("Whoa there! Your browser might choke on saving a map of this size and crash the tab and/or window. Are you sure you want to let it run?")){return false}}artBoard.width=imgBoard.width()-2;artBoard.height=imgBoard.height();if(MAPPER.settings.mode===4){artBoard.width="900px";artBoard.height="1235px"}$("#tiles").find("img").each(function(){artMode.save();a=$(this).position();d=$(this).data("rot");h=$(this).width();b=$(this).height();c.src=$(this).attr("src");a.left-=22;a.top-=22;if(MAPPER.settings.theme===6){artMode.translate(a.left+(h/2),a.top+(b/2));if((d%2)===1){artMode.scale(-1,1)}}else{if((d%2)===1&&h>150&&b<300){a.left-=150;a.top+=75}artMode.translate(a.left+(h/2),a.top+(b/2));artMode.rotate(d*Math.PI/2)}artMode.drawImage(c,-(h/2),-(b/2),h,b);artMode.restore()});$("#grid").find("img").each(function(){artMode.save();a=$(this).position();h=$(this).width();b=$(this).height();c.src=$(this).attr("src");artMode.translate(a.left+(h/2),a.top+(b/2));artMode.drawImage(c,-(h/2),-(b/2),h,b);artMode.restore()});g=artBoard.toDataURL();window.open(g,"MapWindow","width=800,height=600,scrollbars=yes");artBoard.width=artBoard.width*2/2;ga("send","event","Export","Canvas")}else{if((MAPPER.settings.width*MAPPER.settings.height)>64){GUI.showNotification("This map looks too big to export to PNG without causing an error. Sorry!");ga("send","event","Export","Failed")}else{var f,e;GUI.hideNotification();e={tiles:[],rotation:[]};$("#tiles img").each(function(j){e.tiles[j]=$(this).data("imgid");e.rotation[j]=$(this).data("rot")});f="fullmap.php?mapData="+base64_encode(JSON.stringify(e))+"&w="+MAPPER.settings.width+"&h="+MAPPER.settings.height;if(MAPPER.settings.hasEndcaps){f+="&e=1"}else{f+="&e=0"}if(corners){f+="&c=1"}else{f+="&c=0"}f+="&g="+MAPPER.settings.gridType.toString();window.open(f,"MapWindow","width=800,height=600,scrollbars=yes")}ga("send","event","Export","PHP")}}},replaceTile=function(e,b,d,c){var a=tileLibrary[d].draw();e.attr("src","../tiles/"+a.image).data("imgid",a.id).data("artist",a.artist_id);ga("send","event","Replace Tile",d)},onImageDragStart=function(a){a=a.originalEvent;if(MAPPER.isSwapping||!a){return}MAPPER.selectTile($(this));a.dataTransfer.effectAllowed="move";a.dataTransfer.setData("text/html","Swap");ga("send","event","Swap","Drag Start")},onImageDragDrop=function(a){a=a.originalEvent;a.preventDefault();if(a.dataTransfer.getData("text/html")=="Swap"){MAPPER.performSwap($(this));ga("send","event","Swap","Drop")}},onImageClick=function(){if($(this).data("type")==="tab"){return}if(MAPPER.isSwapping){MAPPER.performSwap($(this));ga("send","event","Swap","Tool Complete")}else{MAPPER.selectTile($(this))}},onTileDoubleClick=function(d){var a=$(this),b,c;if(d.metaKey){replaceTile(a,a.data("imgid"),"tile",false);ga("send","event","Replace","Ctrl+DblClick")}else{b=$(this).data("rot");c=(b+1)%4;$(this).data("rot",c).removeClass("rot"+b).addClass("rot"+c);ga("send","event","Rotate","DblClick")}},onEdgeDoubleClick=function(b){if(b.metaKey){var a=$(this);replaceTile(a,a.data("imgid"),"edge",false)}},onCornerDoubleClick=function(b){if(b.metaKey){var a=$(this);replaceTile(a,a.data("imgid"),"corner",false)}},onTopDoubleClick=function(d){var a=$(this),b,c;if(d.metaKey){replaceTile(a,a.data("imgid"),"top",false)}else{b=$(this).data("rot");c=(b+1)%2;$(this).data("rot",c).removeClass("rot"+b).addClass("rot"+c)}},onTopCornerDoubleClick=function(b){if(b.metaKey){var a=$(this);replaceTile(a,a.data("imgid"),"tco",false)}},onBottomDoubleClick=function(d){var a=$(this),b,c;if(d.metaKey){replaceTile(a,a.data("imgid"),"btm",false)}else{b=$(this).data("rot");c=(b+1)%2;$(this).data("rot",c).removeClass("rot"+b).addClass("rot"+c)}},onBottomCornerDoubleClick=function(b){if(b.metaKey){var a=$(this);replaceTile(a,a.data("imgid"),"bco",false)}},onTileBoardClick=function(c){if($(this).hasClass("iconmode")){var f=$(this).offset(),d=c.clientX-f.left-15,b=c.clientY-f.top-15,a=$("<img />").attr("src","../images/fab.png").css({top:b+"px",left:d+"px",width:"30px"}).appendTo($(this))}},initApp=function(){GUI.init();$("#mapTypeMenuBtn").click(toggleMobileMenu);$("#sideBar").on("click tap",function(b){if(b.target.tagName==="SECTION"){$("#sideBar").removeClass("shown")}});$("#artistsblock").on("change","input",function(b){if(b.metaKey){$(this).prop("checked",true).siblings("input").prop("checked",false)}selectTileSets()}).on("dblclick","label",function(){var b=$(this).attr("for");$("#"+b).prop("checked",true).siblings("input").prop("checked",false);selectTileSets()});if(readCookie("popup")!=="overlay"){GUI.showModal(["<h2>New to the Mapper?</h2>","<ul>","<li><strong>Make maps for tabletop RPGs</strong> including caverns, dungeons, vertical dungeons, towns, and spaceships.</li>","<li><strong>Configure your map</strong> using the toolbar above. Choose size, type, layout, and more.</li>","<li><strong>Click tiles</strong> and use the handy selection menu to fine-tune your generated map.</li>","<li><strong>Choose your map artist(s)</strong> by toggling them on the left-hand panel. Double-click an artist or hit the heart button with a tile selected to switch to a single artist.</li>","<li><strong>On multitouch devices</strong> use two-finger twist to rotate tiles.</li>","</ul>","<p><em>Click anywhere to close.</em></p>"].join(""));createCookie("popup","overlay",90);ga("send","event","New User Overlay")}$("#newWindowB").click(exportMap);artBoard=document.getElementById("drawingboard");artMode=artBoard.getContext("2d");$("#newBtn").click(MAPPER.newMap);$("#mapTypeSelector").on("click tap","input:radio[name=maptype]",function(){if($mobilemode){$(this).blur()}MAPPER.settings.theme=parseInt($(this).val(),10);loadRoster()});$("#mapViewControls").on("click tap","#nogrid",function(){MAPPER.applyGridOverlay(0)}).on("click tap","#grid5",function(){MAPPER.applyGridOverlay(1)}).on("click tap","#grid10",function(){MAPPER.applyGridOverlay(2)}).on("click tap","#gridhex",function(){MAPPER.applyGridOverlay(3)});$("#rotateTile").click(function(){if(jQuery.inArray(MAPPER.selectedTile.data("type"),["tile","top","btm"])<0){return false}var b=MAPPER.selectedTile.data("rot"),c=(b+1)%4;MAPPER.selectedTile.data("rot",c).removeClass("rot"+b).addClass("rot"+c);ga("send","event","Rotate","Click");return false});$("#removeTile").click(function(){replaceTile(MAPPER.selectedTile,MAPPER.selectedTile.data("imgid"),MAPPER.selectedTile.data("type"),false);return false});$("#width").val(2);$("#height").val(2);MAPPER.settings.mode=parseInt($("input:radio[name=mode]:checked").val(),10);MAPPER.settings.theme=parseInt($("input:radio[name=maptype]:checked").val(),10);MAPPER.applyGridOverlay($("input:radio[name=grid]:checked").val());loadRoster();if(MAPPER.settings.theme===6){$("#viewport").addClass("sv").removeClass("nm")}else{$("#viewport").addClass("nm").removeClass("sv")}if(($mobilemode)&&(ua.indexOf("Android")>=0)){var a=parseFloat(ua.slice(ua.indexOf("Android")+8));if(a<3){$("body").addClass("faildroid")}}if($appmode){$("body").addClass("standalone-app");$("#notification").css({top:"64px;"});$("#newnav,#site-foot").hide()}if($("canvas#grid").length>0){$("#grid").remove();$("<div id='grid'></div>").appendTo("#map")}imgBoard=$("#tiles");imgBoard.on("dragstart","img",onImageDragStart).on("dragover","img",function(b){b.originalEvent.preventDefault()}).on("drop","img",onImageDragDrop).on("click tap","img",onImageClick).on("dblclick","img.tile",onTileDoubleClick).on("dblclick","img.edge",onEdgeDoubleClick).on("dblclick","img.corner",onCornerDoubleClick).on("dblclick","img.top",onTopDoubleClick).on("dblclick","img.tco",onTopCornerDoubleClick).on("dblclick","img.btm",onBottomDoubleClick).on("dblclick","img.bco",onBottomCornerDoubleClick).on("click",onTileBoardClick);$("#removeTileExit").on("click tap",function(){replaceTile(MAPPER.selectedTile,MAPPER.selectedTile.data("imgid"),MAPPER.selectedTile.data("type"),true);ga("send","event","Remove Tile","Exit");return false});$("#swapTileBtn").on("click tap",function(){if(MAPPER.selectedTile.data("type")==="tab"){return}MAPPER.selectedTile.addClass("swapfirst");MAPPER.isSwapping=true;$("#swapTileBtn").addClass("down");ga("send","event","Swap","Tool Click");return false});$("#mancrush").on("click tap",function(){var b=MAPPER.selectedTile.data("artist");$("#chk"+b).prop("checked",true).siblings("input").prop("checked",false);ga("send","event","Heart","Click");selectTileSets()});$("#width, #height").on("change",MAPPER.newMap);$("input:radio[name=mode]").on("click tap change",function(){MAPPER.settings.mode=parseInt($(this).val(),10);MAPPER.newMap();ga("send","event","Mode","Change")});if("standalone" in window.navigator&&!window.navigator.standalone&&$mobilemode&&$issafari){$('<link rel="stylesheet" href="/style/add2home.css" />').appendTo("body");$('<script src="/scripts/add2home.js"><\/script>').appendTo("body")}},onHammerRotateDetected=function(b){if(MAPPER.selectedTile.data("type")=="tile"){var a=MAPPER.selectedTile.data("rot");MAPPER.isRotating=true;detectedrotate=((a*90)+Math.round(b.gesture.rotation)+360)%360;MAPPER.selectedTile.removeClass("rot"+a).css({"-webkit-transform":"rotateZ("+detectedrotate+"deg)","-moz-transform":"rotateZ("+detectedrotate+"deg)","-ms-transform":"rotateZ("+detectedrotate+"deg)","-o-transform":"rotateZ("+detectedrotate+"deg)",transform:"rotateZ("+detectedrotate+"deg)","-webkit-transition":"none","-moz-transition":"none","-ms-transition":"none","-o-transition":"none",transition:"none",zoom:1});b.gesture.preventDefault();ga("send","event","Rotate","Start Touch")}},onHammerReleaseDetected=function(c){if(MAPPER.isRotating){MAPPER.isRotating=false;var a=MAPPER.selectedTile.data("rot"),b=Math.round(detectedrotate/90)%4;MAPPER.selectedTile.data("rot",b).removeClass("rot"+a).addClass("rot"+b).css({"-webkit-transform":"","-moz-transform":"","-ms-transform":"","-o-transform":"",transform:"","-webkit-transition":"","-moz-transition":"","-ms-transition":"","-o-transition":"",transition:"",zoom:1});detectedrotate=0;ga("send","event","Rotate","Release Touch")}},cappedEndsMode=function(){$("#endBtn").click();MAPPER.newMap()},normalMode=function(){$("#normal").click();MAPPER.newMap()},toggleIconMode=function(){$("#grid").toggleClass("iconmode")},staggeredMode=function(){$("#stagger").click();MAPPER.newMap()},staggeredCappedMode=function(){$("#stagcap").click();MAPPER.newMap()},toggleMobileMenu=function(){$("#sideBar").toggleClass("shown")};$(document).ready(initApp).hammer().on("rotate",onHammerRotateDetected).on("release",onHammerReleaseDetected);